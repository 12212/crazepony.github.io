---
layout: wiki
title: Crazepony5.1版本软件框架讲解
---

# {{ page.title }}

##软件流程图

![](/assets/img/main.png)

Crazepony5.1版本软件流程图总体来说大概就是这样的，Craepony主控使用的是STM32芯片，没有上任何系统使用的是裸奔，所以要依靠中断嵌套来完成整体功能。程序核心就是通过定时器中断置标志位，在主循环中通过不断查询判断各个条件，这样就产生了几个大小不一样的时间段，我们根据需要就可以完成以多大的频率扫描一次遥控器指令、多久更新一次传感器数据、多久更新一次控制等等飞控需要实现的功能，尽可能的利用主控的资源。
进入主函数之后就是处理器和各个部分的初始化了，部分初始化如下

![](/assets/img/main-init.jpg)


接下来就是进入主循环之中了，主循环也就是整个程序功能实现的关键，程序进入这里面就循环在里面运行了，当然中断会打断去运行中断服务程序运行完之后再回到这里运行。主循环体中首先有if(loop200HzCnt >= 5)｛｝这个大的结构，其中loop200HzCnt这个变量是在TIM4中断服务程序中累加的，1ms累加一次，也就是说定时5ms就去完成这个下面功能，这个大if{}结构包含了整个whlie(1)下面的所有内容，在这个下面还嵌套有if(loop50HzFlag)｛｝、if(loop10HzFlag)｛｝、if(pcCmdFlag)｛｝这三个大块的的结构。

程序进入while(1)循环后，程序以200Hz来读取mpu6050数据, 气压计数据并进行整合。因为采用软解姿态, 读取的数据为加速度计和陀螺仪的AD值,将数据进行标定、滤波、校正后通过四元素融合得到三轴欧拉角度。如下图

![](/assets/img/caiji.png)

加速度传感器采集数据容易失真，造成姿态解算出来的欧拉角错误，只用角度单环情况下，使系统很难稳定运行，因此可以加入角速度作为内环，角速度由陀螺仪采集数据输出，采集值一般不存在受外界影响情况，抗干扰能力强，并且角速度变化灵敏，当受外界干扰时回复迅速增强了系统的鲁棒性。 

Crazepony采用双闭环PID控制，如下图所示。

![](/assets/img/jdpid.png)

角度作为外环，角速度作为内环，进行姿态双环PID控制；角度环的输出值作为角速度
环的输入建立自稳系统.


if(loop50HzFlag)这个结构loop50HzFlag标志位是在TIM4中断中每20ms置位一次的，这里解析了收到的遥控器无线发送过来的指令，结合当前的姿态计算更新这些控数据给核心控制算法输出控制飞控，我们就可以控制飞控前进后退，上升下降等等操作了。如下图

![](/assets/img/loop50Hz.jpg)

同样的思路if(loop10HzFlag)也就是以10Hz的频率去执行下面功能，在这里可以通过蓝牙向我们的手机APP传送一些飞控的姿态信息，然后查询飞控的电量没有足够的话就让飞控降落下来，查询高度啊超出可控范围也把飞控降下来，查询是否和遥控器失联啊，失联就降下飞控等等安全飞行的控制。如下图

![](/assets/img/loop10Hz.jpg)

最后就是if(pcCmdFlag)这个了，这是一个与上位机调试有关的东西，主循环查询这个标志位，标志位是由上位机发送过来的指令置位的，它主要是处理pc机发送过来的指令，PID参数读取，修改等等。
