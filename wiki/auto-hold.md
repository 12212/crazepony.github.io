---
layout: wiki
title: 自主悬停
---

自主悬停是Crazepony玩家问得最多的问题，也是技术难度最高的问题。

首先我们明确什么是自主悬停？下面是一位资深航模玩家对于自主悬停的解释。

> 飞行器能够完全自主的悬停在控制某个位置，在发生了偏差之后能够自动校正并且回到原来悬停的位置，并且能够在该位置保持足够长的时间，至少2分钟以上，那么我们认为该飞行器是能够自主悬停的。

飞行器在空中是一个三维坐标位置，所以一般涉及到两个维度的悬停。第一是在水平面上，飞行器不能够左右或者前后漂移。第二是在垂直方向上（一般又叫做Z轴维度），飞行器不能够发生掉高等现象。争对这两个不同的维度，有不同的技术进行解决。

在水平面上，为了确定飞行器的位置，一般使用GPS进行定位，室内一般使用光流进行定位（室内没有gps信号）。

在垂直方向上，一般使用气压计进行定高，室内等条件下可以使用超声波模块。

## 能否只用6维数据实现悬停

能否只使用3维加速度和3维陀螺仪这6个维度的数据实现自主悬停？而不再使用气压计和gps或者光流等。现在就我了解，是很难实现。因为只使用这个6维数据，无法知道飞行器在空中的绝对坐标，只能够由6维数据获得相对偏移。没有绝对坐标，就无法对位置实现闭环控制。

当然，我们看到很多只是用了MPU6050的玩具四轴，也能够实现一定程度的悬停，但是那并不是自主悬停。

## 水平面的定位

室外使用gps进行水平定位，室内一般使用光流技术。

## 垂直方向定位

一般使用高精度气压计（如MS5611）进行高度定位，在较低高度飞行器上，可以使用超声波进行高度定位。

## Crazepony的自动悬停

飞行器要想实现真正意义的自主悬停需要有自稳和空中绝对坐标。Crazepony有一个高精度气压计MS5611，所以可以实现Z轴的自主悬停。在水平方向上，crazepony没有绝对坐标，无法实现悬停。

在Z轴自主悬停上，Crazepony有一个高精度气压计MS5611，通过气压传感器采集的大气压值计算出来，将气压传感器采集值进行校正后，再通过温度二阶补偿，得到准确的大气压值，最后经过气压转换高度公式就可以得到一个相对于起飞地点的绝对高度（参考[气压计MS5611](./ms5611.html)），气压计的精度为10CM, 因此需要融合加速度计互补滤波得到比较合适的高度值、Z轴速度值和加速度值。用高度作外环、速度作内环形成高度双环PID控制器，调节输出油门实现Z轴的自主悬停。

高度控制总体流程
![](/assets/img/gdpid.png)
在水平方向上，由于Crazepony没有绝对坐标，使用3维加速度和3维陀螺仪这6个维度的数据进行双环PID控制形成一个自稳系统，可实现短时间定点脱控悬停，但是受误差影响产生偏离，没有水平绝对坐标就无法回到原来的位置，所以Crazepony是无法实现正真意义上自动悬停的。

##控制油门输出

根据机重和动力系统的输出，我们为Crazepony设定了一个最小的油门输出值`THR_MIN`，这样能够限制最大的下降速度。可以避免下降速度过快，机身失去平衡。

control.h文件中的`THR_MIN`定义：

~~~
#define ALT_VEL_MAX                     4.0f
#define THR_MIN                         0.42f       //min thrust ，根据机重和最小降速而定，用于下降速度过大时，油门过小，导致失衡。再增加fuzzy control ，在油门小时用更大的姿态参数

#define HOVER_THRU           -0.63  //-0.5f  //悬停
~~~

当然，这个最小的油门输出值`THR_MIN`有时候也会带来副作用。例如充电后第一次飞行，由于动力输出强劲，如果这个最小油门输出值设置得过大，那么即使将摇杆油门拉到了最低，飞机也会一直往上冲。为此，我们将该值由又来的0.5f改为了0.42f，能够解决绝大部分往上冲的问题。
